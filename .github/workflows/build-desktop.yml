name: Build Desktop App

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            artifact: Crystal-Windows-*.exe
          - os: macos-latest
            platform: mac
            artifact: Crystal-Mac-*.dmg
          - os: ubuntu-latest
            platform: linux
            artifact: Crystal-Linux-*.AppImage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: crystal-desktop-app/package-lock.json

      - name: Install dependencies
        working-directory: crystal-desktop-app
        run: npm ci

      - name: Create production environment file
        working-directory: crystal-desktop-app
        run: |
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}" > .env.production
          echo "VITE_HOST_URL=https://www.crystalapp.tech/api" >> .env.production
          echo "VITE_APP_URL=https://www.crystalapp.tech" >> .env.production
          echo "VITE_SOCKET_URL=https://project-crystal-application-production.up.railway.app" >> .env.production
          echo "APP_ROOT=https://www.crystalapp.tech" >> .env.production

      - name: Get version from package.json
        id: get_version
        working-directory: crystal-desktop-app
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build Electron app
        working-directory: crystal-desktop-app
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload Windows build to S3
        if: matrix.platform == 'win'
        working-directory: crystal-desktop-app
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          if ([string]::IsNullOrEmpty($version)) { $version = "0.0.1" }
          aws s3 cp "release/$version/" "s3://${{ secrets.AWS_BUCKET }}/desktop-app/releases/v$version/" --recursive --exclude "*" --include "*.exe"
        shell: pwsh

      - name: Upload Mac build to S3
        if: matrix.platform == 'mac'
        working-directory: crystal-desktop-app
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.1"; fi
          aws s3 cp release/$VERSION/ "s3://${{ secrets.AWS_BUCKET }}/desktop-app/releases/v$VERSION/" --recursive --exclude "*" --include "*.dmg"
        shell: bash

      - name: Upload Linux build to S3
        if: matrix.platform == 'linux'
        working-directory: crystal-desktop-app
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [ -z "$VERSION" ]; then VERSION="0.0.1"; fi
          aws s3 cp release/$VERSION/ "s3://${{ secrets.AWS_BUCKET }}/desktop-app/releases/v$VERSION/" --recursive --exclude "*" --include "*.AppImage"
        shell: bash

      - name: Upload artifact (for GitHub releases)
        uses: actions/upload-artifact@v4
        with:
          name: crystal-${{ matrix.platform }}
          path: |
            crystal-desktop-app/release/${{ steps.get_version.outputs.VERSION }}/${{ matrix.artifact }}
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/crystal-win/**/*
            artifacts/crystal-mac/**/*
            artifacts/crystal-linux/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

